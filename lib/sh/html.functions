
# --------------------------------------------------------------------------- #
  function writeTeXsrc() { echo "$1" >> $TMPTEX ; }
# --------------------------------------------------------------------------- #

# MAIN MDSH FUNCTION
# --------------------------------------------------------------------------- #
  function mdsh2TeX() {
# --------------------------------------------------------------------------- #
# INCLUDE FUNCTIONS
# --------------------------------------------------------------------------- #
  source $FUNCTIONS

# --------------------------------------------------------------------------- #
  IFHTTP=`echo $1 | grep "http.\?://" | wc -l`
  if [ $IFHTTP -ge 1 ]; then
   URL=$1
   NAME=`echo $1 | md5sum | cut -c 1-10`
   wget --no-check-certificate -O ${TMPDIR}/${NAME}.mdsh $URL > /dev/null 2>&1
   MDSH=${TMPDIR}/${NAME}.mdsh
  else 
   MDSH=$1
  fi

  MDSHMOD=$TMPDIR/tmp-`echo $MDSH | md5sum | cut -c 1-8`.mdsh
# --------------------------------------------------------------------------- #
# - CONVERT MDSH TO HTML 
# - ...
# --------------------------------------------------------------------------- #

  cat $MDSH                              | # USELESS USE OF CAT
  sed 's/^%/\n\nzDf7WV362LoP/g'          | # SAVE COMMENTS FROM PANDOC
  sed '/zDf7WV362LoP/s/$/\n\n/'          | #
  pandoc --ascii -r markdown -w html     | #
  sed "s/<p>//g"                         | # 
  sed "s/<\/p>//g"                       | # 
  sed 's/zDf7WV362LoP/%/g'               | # BACK TO ORIGINAL
  sed 's/code>/tt>/g'                    | #
  sed -e 's/^% TITLE:/%TXIXTXLXE/g' \
      -e '/^%TXIXTXLXE/s/ /_/g' \
      -e 's/%TXIXTXLXE/% TITLE:/g'       | # REMOVE SPACES FROM TITLE
  sed -e 's/^% LABEL:/%LXAXBXEXL/g' \
      -e '/^%LXAXBXEXL/s/ /_/g' \
      -e 's/%LXAXBXEXL/% LABEL:/g'       | # REMOVE SPACES FROM LABEL
  tee > $MDSHMOD                           # WRITE TO FILE

# cp $MDSHMOD `date +%s`.mdsh
# cp $MDSHMOD debug.1

# --------------------------------------------------------------------------- #
# PARSE COMMANDS 
# --------------------------------------------------------------------------- #

  for LINE in `cat $MDSHMOD | sed 's, ,DieW73NaS03J,g'`
   do 
      # --------------------------------------------------- # 
      # RESTORE SPACES
        LINE=`echo $LINE | sed 's,DieW73NaS03J, ,g'`
      # --------------------------------------------------- #  
      # CHECK IF LINE STARTS WITH A %
        ISCMD=`echo $LINE | grep ^% | wc -l` 
      # --------------------------------------------------- # 
      # IF LINE STARTS WITH A %
        if [ $ISCMD -ge 1 ]; then
 
           CMD=`echo $LINE | \
                cut -d "%" -f 2 | \
                cut -d ":" -f 1 | \
                sed 's/\[/ /g' | sed 's/\]/ /g' |\
                sed 's, ,,g'`
           ARG=`echo $LINE | cut -d ":" -f 2-`
      # --------------------------------------------------- # 
      # CHECK IF COMMAND EXISTS

           CMDEXISTS=`grep "^function ${CMD}()" $FUNCTIONS |\
                      wc -l`
      # --------------------------------------------------- # 
      # IF COMMAND EXISTS 
        if [ $CMDEXISTS -ge 1 ]; then
           # EXECUTE COMMAND
             $CMD $ARG
        fi
      # --------------------------------------------------- # 
      # IF LINE DOES NOT START WITH % (= SIMPLE MARKDOWN)
        else
      # --------------------------------------------------- # 
      # APPEND LINE TO TEX FILE
        echo "$LINE" >> $TEXBODY
        fi
      # --------------------------------------------------- # 
  done

# cp $TEXBODY debug.2


  }
# --------------------------------------------------------------------------- #

function NOWSPEAKING() {

   ID=`echo $1 | tr [:upper:] [:lower:]`
   START="<p class=\"$ID\">"
   writeTeXsrc "$END"
   writeTeXsrc "$START"
   END="</p>"
}

# --------------------------------------------------------------------------- #

function TITLE() {

  # NOT WORKING FOR NESTED DOCUMENTS
  # TITLE=`grep "^% TITLE:" $MDSHMOD |  tail -1 | \
  #        cut -d ":" -f 2- | sed "s/^[ \t]*//" | sed "s/[ \t]*$//"`

  TITLE=`echo $1 | sed 's/_/ /g' | sed "s/^[ \t]*//" | sed "s/[ \t]*$//"`

  writeTeXsrc "<h1>$TITLE</h1>"

}

# --------------------------------------------------------------------------- #

function LABEL(){

  LABEL=`echo $1 | sed 's/_/ /g' | sed "s/^[ \t]*//" | sed "s/[ \t]*$//"`

  writeTeXsrc "<h2>$LABEL</h2>"

}

# --------------------------------------------------------------------------- #


